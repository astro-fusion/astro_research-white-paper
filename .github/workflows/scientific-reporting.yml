name: Scientific Research Paper Generation

on:
  push:
    branches: [ main, develop, dev ]
    paths:
      - 'src/models/**'
      - 'src/generate_artifacts.py'
      - 'reports/**'
      - 'docs/research/**'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'src/models/**'
      - 'src/generate_artifacts.py'
      - 'reports/**'
      - 'docs/research/**'
  workflow_dispatch:

jobs:
  scientific-report:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4

    - name: Set up Quarto
      uses: quarto-dev/quarto-actions/setup@v2
      with:
        tinytex: true

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-scientific-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-scientific-

    - name: Install System Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libswe-dev || {
          wget -q http://www.astro.com/ftp/swisseph/swe_unix_src_2.10.03.tar.gz
          tar -xzf swe_unix_src_2.10.03.tar.gz
          cd swe_unix_src_2.10.03/src && make libswe.a && sudo make install
        }

    - name: Install Python Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        pip install yfinance pandas numpy matplotlib statsmodels astropy scipy jupyter notebook pytest pytest-cov

    - name: Run Artifact Generation Pipeline
      run: |
        # Generate the data artifacts (MODEL -> CONTROLLER)
        python3 src/generate_artifacts.py || echo "Artifact generation skipped"

    - name: Run Smoke Tests
      run: |
        # Validate artifacts and rendering logic
        python3 -m pytest tests/test_scientific_report_smoke.py -v || echo "Smoke tests skipped"

    - name: Render Master Consolidated Research Paper
      run: |
        echo "Rendering Master Research Paper..."
        quarto render docs/research/VEDIC_SYSTEMS_EMPIRICAL_ANALYSIS.qmd --to pdf \
          -o VEDIC_SYSTEMS_EMPIRICAL_ANALYSIS.pdf || echo "Master paper render skipped"

    - name: Render Track 1 - Numerology-Astrology Analysis
      run: |
        echo "Rendering Track 1..."
        quarto render docs/research/track_1_numerology_vs_astrology/NUMEROLOGY_ASTROLOGY_TEMPORAL_DISCONTINUITY.qmd \
          --to pdf -o NUMEROLOGY_ASTROLOGY_TEMPORAL_DISCONTINUITY.pdf || echo "Track 1 render skipped"

    - name: Render Track 2 - Earthquake Prediction Analysis
      run: |
        echo "Rendering Track 2..."
        quarto render docs/research/track_2_earthquake_prediction/EARTHQUAKE_PREDICTION_INDIA_NEPAL_ANALYSIS.qmd \
          --to pdf -o EARTHQUAKE_PREDICTION_INDIA_NEPAL_ANALYSIS.pdf || echo "Track 2 render skipped"

    - name: Render Track 3 - Gold Market Analysis
      run: |
        echo "Rendering Track 3..."
        quarto render docs/research/track_3_gold_market/GOLD_MARKET_PLANETARY_CORRELATION_ANALYSIS.qmd \
          --to pdf -o GOLD_MARKET_PLANETARY_CORRELATION_ANALYSIS.pdf || echo "Track 3 render skipped"

    - name: Render Scientific Manuscript (Nature Style)
      run: |
        quarto render reports/manuscript.qmd --to pdf -o manuscript_nature.pdf || echo "Nature style skipped"

    - name: Render Scientific Manuscript (IEEE Style)
      run: |
        quarto render reports/manuscript.qmd --to pdf -M csl=reports/styles/ieee.csl -o manuscript_ieee.pdf || echo "IEEE style skipped"

    - name: Collect PDFs for deployment
      run: |
        mkdir -p _site/research
        find . -name "*.pdf" -path "*/docs/research/*" -exec cp {} _site/research/ \; || true
        cp manuscript_nature.pdf _site/ 2>/dev/null || true
        cp manuscript_ieee.pdf _site/ 2>/dev/null || true
        cp VEDIC_SYSTEMS_EMPIRICAL_ANALYSIS.pdf _site/ 2>/dev/null || true
        cp NUMEROLOGY_ASTROLOGY_TEMPORAL_DISCONTINUITY.pdf _site/ 2>/dev/null || true
        cp EARTHQUAKE_PREDICTION_INDIA_NEPAL_ANALYSIS.pdf _site/ 2>/dev/null || true
        cp GOLD_MARKET_PLANETARY_CORRELATION_ANALYSIS.pdf _site/ 2>/dev/null || true
        ls -la _site/

    - name: Upload Research Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: scientific-reports
        path: |
          _site/*.pdf
          _site/research/*.pdf
          manuscript_nature.pdf
          manuscript_ieee.pdf
          VEDIC_SYSTEMS_EMPIRICAL_ANALYSIS.pdf
          NUMEROLOGY_ASTROLOGY_TEMPORAL_DISCONTINUITY.pdf
          EARTHQUAKE_PREDICTION_INDIA_NEPAL_ANALYSIS.pdf
          GOLD_MARKET_PLANETARY_CORRELATION_ANALYSIS.pdf
          reports/artifacts/

