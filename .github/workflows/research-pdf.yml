name: Research PDF Generation

on:
  push:
    branches: [ main ]
    paths:
      - 'use_cases/numerology/manuscripts/manuscript.qmd'
      - 'src/**'
      - '_quarto.yml'
      - 'references.bib'
  pull_request:
    paths:
      - 'use_cases/numerology/manuscripts/manuscript.qmd'
      - 'src/**'
      - '_quarto.yml'
      - 'references.bib'
  workflow_dispatch:
    inputs:
      birth_date:
        description: 'Birth date for analysis (YYYY-MM-DD)'
        required: false
        default: '1984-08-27'
      birth_time:
        description: 'Birth time (HH:MM)'
        required: false
        default: '10:30'
      latitude:
        description: 'Birth latitude'
        required: false
        default: '28.6139'
      longitude:
        description: 'Birth longitude'
        required: false
        default: '77.1025'
      generate_reports:
        description: 'Generate additional research reports'
        required: false
        default: true
        type: boolean

jobs:
  build-research-pdf:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Quarto
      run: |
        # Install Quarto manually to avoid architecture issues
        wget -q https://github.com/quarto-dev/quarto-cli/releases/download/v1.4.554/quarto-1.4.554-linux-amd64.deb
        sudo dpkg -i quarto-1.4.554-linux-amd64.deb || sudo apt-get install -f -y
        # Add Quarto to PATH
        echo "/opt/quarto/bin" >> $GITHUB_PATH
        quarto install tinytex

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: Install system dependencies
      run: |
        sudo apt-get update
        # Try to install Swiss Ephemeris library (may not be available in standard repos)
        sudo apt-get install -y libswe-dev || {
          echo "libswe-dev not available, installing build dependencies to compile from source..."
          sudo apt-get install -y build-essential wget
          # Download and install Swiss Ephemeris from source
          wget -q http://www.astro.com/ftp/swisseph/swe_unix_src_2.10.03.tar.gz
          tar -xzf swe_unix_src_2.10.03.tar.gz
          cd swe_unix_src_2.10.03/src
          make libswe.a
          sudo make install
          cd ../..
          rm -rf swe_unix_src_2.10.03*
        }

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        pip install pyswisseph>=2.08.00 matplotlib seaborn plotly numpy pandas

    - name: Generate dynamic research content
      run: |
        python -c "
        from vedic_astrology_core import create_birth_chart
        import matplotlib
        matplotlib.use('Agg')
        import matplotlib.pyplot as plt
        import sys
        sys.path.insert(0, 'use_cases/numerology/src')
        from numerology.calculator import calculate_complete_numerology
        from datetime import datetime

        # Use workflow inputs or defaults
        birth_date = '${{ github.event.inputs.birth_date || '1984-08-27' }}'
        birth_time = '${{ github.event.inputs.birth_time || '10:30' }}'
        latitude = float('${{ github.event.inputs.latitude || '28.6139' }}')
        longitude = float('${{ github.event.inputs.longitude || '77.1025' }}')

        print(f'Generating analysis for: {birth_date} {birth_time}')
        print(f'Location: {latitude}째N, {longitude}째E')

        # Create astrology chart
        chart = create_birth_chart(birth_date, birth_time, latitude, longitude)

        # Calculate numerology
        numerology = calculate_complete_numerology(
            datetime.strptime(birth_date, '%Y-%m-%d').date(),
            datetime.strptime(birth_time, '%H:%M').time() if birth_time != 'None' else None,
            latitude,
            longitude
        )

        # Get dignity scores for numerology planets
        mars_dignity = chart.score_dignity('MARS')
        venus_dignity = chart.score_dignity('VENUS')

        # Create results file for Quarto to include
        with open('research_results.json', 'w') as f:
            import json
            json.dump({
                'birth_data': {
                    'date': birth_date,
                    'time': birth_time,
                    'latitude': latitude,
                    'longitude': longitude
                },
                'numerology': numerology,
                'astrology': {
                    'mars_dignity': mars_dignity,
                    'venus_dignity': venus_dignity,
                    'ascendant': chart.chart.ascendant['sign_name'] if isinstance(chart.chart.ascendant, dict) else str(chart.chart.ascendant)
                },
                'support_analysis': {
                    'mars_score': mars_dignity['score'],
                    'venus_score': venus_dignity['score'],
                    'mars_type': mars_dignity['dignity_type'],
                    'venus_type': venus_dignity['dignity_type']
                }
            }, f, indent=2, default=str)

        print('Research data generated successfully')
        "

    - name: Copy research data to manuscript directory
      run: |
        mkdir -p use_cases/numerology/manuscripts
        cp research_results.json use_cases/numerology/manuscripts/

    - name: Render research manuscript to PDF
      run: |
        echo "Rendering manuscript with dynamic research content..."
        cd use_cases/numerology/manuscripts
        quarto render manuscript.qmd --to pdf --pdf-engine lualatex
        ls -la *.pdf

    - name: Generate additional research reports
      if: github.event.inputs.generate_reports == 'true' || github.event_name != 'workflow_dispatch'
      run: |
        python -c "
        from vedic_astrology_core import create_birth_chart
        import json

        # Load the generated research results
        try:
            with open('research_results.json', 'r') as f:
                data = json.load(f)

            analysis = create_birth_chart(
                data['birth_data']['date'],
                data['birth_data']['time'],
                data['birth_data']['latitude'],
                data['birth_data']['longitude']
            )

            # Generate comprehensive report
            report = analysis.generate_report()
            with open('comprehensive_analysis_report.txt', 'w') as f:
                f.write(report)

            # Generate summary statistics
            support_data = data['support_analysis']
            summary = f'''
        # Vedic Numerology-Astrology Analysis Summary

        ## Birth Data
        - Date: {data['birth_data']['date']}
        - Time: {data['birth_data']['time']}
        - Location: {data['birth_data']['latitude']}째N, {data['birth_data']['longitude']}째E

        ## Numerology Results
        - Mulanka: {data['numerology']['mulanka']['number']} ({data['numerology']['mulanka']['planet']})
        - Bhagyanka: {data['numerology']['bhagyanka']['number']} ({data['numerology']['bhagyanka']['planet']})

        ## Support Analysis
        - Mulanka Support: {support_data['mulanka']['support_level']} ({support_data['mulanka']['score']:.1f}/100)
        - Bhagyanka Support: {support_data['bhagyanka']['support_level']} ({support_data['bhagyanka']['score']:.1f}/100)
        - Overall Harmony: {support_data['overall']['harmony_level']}
        - Average Score: {support_data['overall']['average_score']:.1f}/100

        ## Dignity Details
        ### Mulanka ({support_data['mulanka']['planet']})
        - Dignity Type: {support_data['mulanka']['dignity_type']}
        - Detailed Score: {support_data['mulanka']['score']:.1f}/100

        ### Bhagyanka ({support_data['bhagyanka']['planet']})
        - Dignity Type: {support_data['bhagyanka']['dignity_type']}
        - Detailed Score: {support_data['bhagyanka']['score']:.1f}/100

        ---
        Generated by Vedic Numerology-Astrology Integration System
        Research Date: $(date)
            '''

            with open('analysis_summary.md', 'w') as f:
                f.write(summary)

            print('Additional research reports generated')

        except Exception as e:
            print(f'Report generation failed: {e}')
        "

    - name: Upload research PDF
      uses: actions/upload-artifact@v4
      with:
        name: research-manuscript-pdf
        path: use_cases/numerology/manuscripts/manuscript.pdf

    - name: Upload research data and reports
      uses: actions/upload-artifact@v4
      with:
        name: research-data-reports
        path: |
          research_results.json
          comprehensive_analysis_report.txt
          analysis_summary.md
          figures/*.png

    - name: Upload PDF to GitHub Pages (optional)
      if: github.ref == 'refs/heads/main'
      uses: actions/upload-artifact@v4
      with:
        name: github-pages-pdf
        path: use_cases/numerology/manuscripts/manuscript.pdf
        retention-days: 30