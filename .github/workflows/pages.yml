name: Deploy Research Platform

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      deploy_type:
        description: 'Deployment type'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - static-only
          - app-only
          - docs-only

# Sets permissions for deployment
permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "research-platform"
  cancel-in-progress: false

jobs:
  build:
    name: Build Content
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Pages
      uses: actions/configure-pages@v4

    - name: Set up Quarto
      uses: quarto-dev/quarto-actions/setup@v2
      with:
        tinytex: true

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-pages-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-pages-

    - name: Install system dependencies
      run: sudo apt-get update && (
        # Try to install Swiss Ephemeris library (may not be available in standard repos)
        sudo apt-get install -y libswe-dev || {
          echo "libswe-dev not available, installing build dependencies to compile from source..."
          sudo apt-get install -y build-essential wget
          # Download and install Swiss Ephemeris from source
          wget -q http://www.astro.com/ftp/swisseph/swe_unix_src_2.10.03.tar.gz
          tar -xzf swe_unix_src_2.10.03.tar.gz
          cd swe_unix_src_2.10.03/src
          make libswe.a
          sudo make install
          cd ../..
          rm -rf swe_unix_src_2.10.03*
        }
      )

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -e ".[dev]"
        pip install pyswisseph>=2.08.00 sphinx sphinx-rtd-theme myst-parser

    # Build manuscripts (HTML, PDF, DOCX)
    - name: Build Manuscripts
      if: github.event.inputs.deploy_type != 'docs-only' || github.event_name == 'push'
      run: |
        echo "Building manuscripts..."
        ./build.sh html
        ./build.sh pdf
        ./build.sh docx

    # Build API documentation
    - name: Build API Documentation
      if: github.event.inputs.deploy_type != 'static-only' || github.event_name == 'push'
      run: |
        echo "Building API documentation..."
        mkdir -p docs/api
        python -m sphinx -b html docs/ docs/_build/html

    # Create combined site structure
    - name: Create Site Structure
      run: |
        mkdir -p _site

        # Copy manuscript HTML as main content
        if [ -f "_book/html/manuscript.html" ]; then
          cp _book/html/manuscript.html _site/manuscript.html
          cp -r _book/html/* _site/ 2>/dev/null || true
        fi

        # Copy API documentation
        if [ -d "docs/_build/html" ]; then
          mkdir -p _site/docs
          cp -r docs/_build/html/* _site/docs/
        fi

        # Copy the custom index.html (if it exists)
        if [ -f "_site/index.html" ]; then
          echo "Using existing index.html"
        else
          echo "Creating basic index.html"
          cp manuscript.html _site/index.html 2>/dev/null || echo "No manuscript.html found"
        fi

    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: _site

  deploy:
    name: Deploy to GitHub Pages
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build

    steps:
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4